services:
  authentik:
    image: ghcr.io/goauthentik/server:2025.10.3
    container_name: authentik-server
    restart: unless-stopped
    command: server
    environment:
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY}
      - AUTHENTIK_ERROR_REPORTING__ENABLED=false
      - AUTHENTIK_POSTGRESQL__HOST=authentik_postgres
      - AUTHENTIK_POSTGRESQL__USER=${DATABASE_USER}
      - AUTHENTIK_POSTGRESQL__NAME=${DATABASE_NAME}
      - AUTHENTIK_POSTGRESQL__PASSWORD=${DATABASE_PASSWORD}
    networks:
      - authentik_backend
      - proxy  # Matches your Traefik network
    volumes:
      - authentik_media:/media
      - authentik_templates:/templates
    labels:
      # Traefik Enable & Network
      - traefik.enable=true
      - traefik.docker.network=proxy
      
      # HTTP Service Definition
      - traefik.http.services.authentik.loadbalancer.server.port=9000

      # HTTP Router (redirects to HTTPS)
      - traefik.http.routers.authentik-http.rule=Host(`authentik.local.raghavvram.online`)
      - traefik.http.routers.authentik-http.service=authentik
      - traefik.http.routers.authentik-http.entrypoints=http
      - traefik.http.routers.authentik-http.middlewares=traefik-https-redirect@docker  # Your global redirect

      # HTTPS Router (secure access)
      - traefik.http.routers.authentik-https.rule=Host(`authentik.local.raghavvram.online`)
      - traefik.http.routers.authentik-https.service=authentik
      - traefik.http.routers.authentik-https.entrypoints=https
      - traefik.http.routers.authentik-https.tls=true
      - traefik.http.routers.authentik-https.tls.certresolver=cloudflare
      - traefik.http.routers.authentik-https.tls.domains[0].main=local.raghavvram.online
      - traefik.http.routers.authentik-https.tls.domains[0].sans=*.local.raghavvram.online

      # Authentik Forward Auth Middleware (protect other services)
      - "traefik.http.middlewares.authentik-forwardauth.forwardauth.address=http://authentik:9000/outpost.goauthentik.io/auth/traefik"
      - "traefik.http.middlewares.authentik-forwardauth.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.authentik-forwardauth.forwardauth.authResponseHeaders=X-authentik-username,X-authentik-groups,X-authentik-entitlements,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-jwt,X-authentik-meta-jwks,X-authentik-meta-outpost,X-authentik-meta-provider,X-authentik-meta-app,X-authentik-meta-version"
    depends_on:
      - authentik_postgres

  authentik_worker:
    image: ghcr.io/goauthentik/server:2025.10.3
    container_name: authentik-worker
    restart: unless-stopped
    command: worker
    environment:
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY}
      - AUTHENTIK_ERROR_REPORTING__ENABLED=false
      - AUTHENTIK_POSTGRESQL__HOST=authentik_postgres
      - AUTHENTIK_POSTGRESQL__USER=${DATABASE_USER}
      - AUTHENTIK_POSTGRESQL__NAME=${DATABASE_NAME}
      - AUTHENTIK_POSTGRESQL__PASSWORD=${DATABASE_PASSWORD}
      - AUTHENTIK_BOOTSTRAP_PASSWORD=${AUTHENTIK_ADMIN_PASSWORD}
    user: root
    networks:
      - authentik_backend
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - authentik_media:/media
      - authentik_certs:/certs
      - authentik_templates:/templates
    depends_on:
      - authentik_postgres

  authentik_postgres:
    image: docker.io/library/postgres:17.7
    container_name: authentik-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${DATABASE_USER}
      - POSTGRES_PASSWORD=${DATABASE_PASSWORD}
      - POSTGRES_DB=${DATABASE_NAME}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER}"]
      start_period: 30s
      interval: 10s
      timeout: 10s
      retries: 5
    networks:
      - authentik_backend
    volumes:
      - authentik_postgres:/var/lib/postgresql/data

networks:
  authentik_backend:
    driver: bridge
  proxy:
    external: true

volumes:
  authentik_postgres:
    driver: local
  authentik_media:
    driver: local
  authentik_certs:
    driver: local
  authentik_templates:
    driver: local
